<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>积分商城控制台</title>
    <link rel="stylesheet" href="/css/bulma.min.css" />
    <script src="/js/vue.3.5.12.js"></script>
    <script src="/js/axios.min.js"></script>
    <script src="/js/crypto-js.min.js"></script>
    <style scoped>
      #main-loading {
        display: none;
      }

      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f0f0f0;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      /* 悬浮通知样式 */
      .notification-fixed {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        width: 90%;
        max-width: 500px;
      }

      /* 滑入和淡出动画 */
      .slide-fade-enter-active {
        animation: slideIn 0.5s ease-out;
      }

      .slide-fade-leave-active {
        animation: fadeOut 0.5s ease-out;
      }

      @keyframes slideIn {
        from {
          transform: translate(-50%, -100%);
          opacity: 0;
        }

        to {
          transform: translate(-50%, 0);
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }

        to {
          opacity: 0;
        }
      }

      .button-group {
        display: inline-flex;
        border: 1px solid #e4e4e4;
        border-color: var(--bulma-border);
        border-radius: 24px;
        overflow: hidden;
      }

      .toggle-button {
        flex: 1;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .toggle-button.is-active {
        background-color: var(--bulma-scheme-main);
        color: var(--bulma-success);
      }

      a {
        color: var(--bulma-success);
      }

      .fixed-save-button {
        width: 6rem;
        height: 6rem;
        position: fixed;
        bottom: 20px;
        right: 20px;
        border-radius: 50%;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.2s, transform 0.2s;
        color: #fff;
      }

      .fixed-save-button:hover {
        background-color: var(--bulma-success-45);
        transform: translateY(-2px);
      }
    </style>
  </head>

  <body>
    <div class="columns menu-container" id="app">
      <div class="column" id="main-content">
        <transition name="slide-fade" @after-leave="hideNotification">
          <div
            v-if="isNotificationVisible"
            class="notification notification-fixed"
            :class="notificationType"
          >
            <button class="delete" @click="hideNotification"></button>
            {{ notificationMessage }}
          </div>
        </transition>

        <div id="main-content-body" style="padding: 1rem">
          <div class="column is-full">
            <article class="message" v-if="loading">
              <div class="message-header">
                <p>请稍等</p>
              </div>
              <div class="message-body">商城正在构建中</div>
            </article>
            <article class="message" v-else>
              <div class="message-header">
                <p>恭喜你！</p>
              </div>
              <div class="message-body">
                你已经成功部署了本项目<br />
                此页面为初始化配置页面，为本项目提供最基础的配置信息<br />
                通常情况下<strong>不需要</strong>进行任何更改，直接构建商城即可<br />
              </div>
            </article>
          </div>

          <div class="column is-full" v-if="!loading">
            <div class="card">
              <div class="card-content">
                <!-- 项目地址 -->
                <div class="field">
                  <label class="label">项目地址</label>
                  <div class="control">
                    <input
                      class="input"
                      type="text"
                      v-model="form.system_api_url"
                    />
                  </div>
                  <p class="help">
                    积分商城控制台默认地址，如果需要通过域名进行访问，可以通过
                    <a href="https://dc.console.aliyun.com/">阿里云</a> 或
                    <a href="https://www.godaddy.com/">godaddy</a>
                    等平台注册域名，通常费用在每年几十元左右。
                  </p>
                  <p class="help">
                    购买域名后解析到服务器后，就可以拥有一个网址链接供粉丝访问。如需帮助请
                    <a href="mailto:junjie.he.925@gmail.com">联系作者</a>。
                  </p>
                  <p class="help">
                    如果没有域名，也可以按照当前配置的 IP
                    链接进行访问，或生成二维码供手机扫码访问。
                  </p>
                </div>

                <!-- AES加密KEY -->
                <div class="field">
                  <label class="label">AES加密KEY</label>
                  <div class="control">
                    <input
                      class="input"
                      type="text"
                      v-model="form.system_aes_key"
                    />
                  </div>
                  <p class="help">
                    用于前后端数据加密与解密，影响数据传输的安全性，特别是在涉及敏感数据的模块中。
                  </p>
                </div>

                <!-- AES加密IV -->
                <div class="field">
                  <label class="label">AES加密IV</label>
                  <div class="control">
                    <input
                      class="input"
                      type="text"
                      v-model="form.system_aes_iv"
                    />
                  </div>
                  <p class="help">
                    与 AES KEY 配合使用，确保加解密过程的安全性。
                  </p>
                </div>

                <!-- 签名KEY -->
                <div class="field">
                  <label class="label">签名KEY</label>
                  <div class="control">
                    <input
                      class="input"
                      type="text"
                      v-model="form.system_key"
                    />
                  </div>
                  <p class="help">
                    用于请求数据签名校验，确保传输过程不被篡改。
                  </p>
                </div>

                <!-- 商城名称 -->
                <div class="field">
                  <label class="label">商城名称</label>
                  <div class="control">
                    <input class="input" type="text" v-model="form.shop_name" />
                  </div>
                  <p class="help">打开网页时显示的网站名称</p>
                </div>

                <!-- 商城地址 -->
                <div class="field">
                  <label class="label">商城地址</label>
                  <div class="control">
                    <input class="input" type="text" v-model="form.shop_url" />
                  </div>
                  <p class="help">
                    积分商城默认地址，如果需要通过域名进行访问，可以通过
                    <a href="https://dc.console.aliyun.com/">阿里云</a> 或
                    <a href="https://www.godaddy.com/">godaddy</a>
                    等平台注册域名，通常费用在每年几十元左右。
                  </p>
                  <p class="help">
                    购买域名后解析到服务器后，就可以拥有一个网址链接供粉丝访问。如需帮助请
                    <a href="mailto:junjie.he.925@gmail.com">联系作者</a>。
                  </p>
                  <p class="help">
                    如果没有域名，也可以按照当前配置的 IP
                    链接进行访问，或生成二维码供手机扫码访问。
                  </p>
                </div>

                <div class="field">
                  <button
                    class="button is-link is-fullwidth"
                    @click="saveData"
                    :class="buildLoading ? 'is-loading' : ''"
                  >
                    构建商城
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
    const app = Vue.createApp({
      data() {
        return {
          secretKey: "<?php echo $secretKey ?>",
          isNotificationVisible: false,
          notificationMessage: null,
          notificationType: "",
          loading: false,
          buildLoading: false,
          form: {
            shop_name: "",
            shop_url: "",
            system_api_url: "",
            system_aes_key: "",
            system_aes_iv: "",
            system_key: "",
          },
        };
      },
      created() {
        this.getData();
      },
      methods: {
        // 显示通知
        showNotification(message, type = "info") {
          this.isNotificationVisible = true;
          this.notificationMessage = message;
          this.notificationType = this.getNotificationClass(type);
          setTimeout(this.hideNotification, 5000);
        },

        // 获取通知的样式
        getNotificationClass(type) {
          const types = {
            success: "is-success is-light",
            info: "is-light",
            error: "is-danger is-light",
            warning: "is-warning is-light",
          };
          return types[type] || "is-light";
        },

        // 隐藏通知
        hideNotification() {
          this.isNotificationVisible = false;
        },

        // 获取页面数据
        getData() {
          const data = {};
          const signature = this.generateSignature(data);
          this.loading = true;
          axios
            .post("/api/points-mall/system-configuration/get-init-data", data, {
              headers: { "X-Signature": signature },
            })
            .then((response) => {
              if (response.data.code === 0) {
                if (response.data.data.is_path) {
                  window.location.href = response.data.data.path;
                }
                this.loading = response.data.data.loading;
                this.form = response.data.data;
                if (!this.form.shop_name) {
                  this.form.shop_name = "积分商城";
                }
                if (!this.form.shop_url) {
                  this.form.shop_url =
                    window.location.protocol +
                    "//" +
                    window.location.hostname +
                    ":5177";
                }
                if (!this.form.system_api_url) {
                  this.form.system_api_url =
                    window.location.protocol + "//" + window.location.host;
                }
              }
            })
            .catch(() => {
              this.showNotification("请求失败，请稍后重试", "error");
            });
        },

        // 存储信息
        saveData() {
          this.buildLoading = true;
          const data = this.form;
          const signature = this.generateSignature(data);
          axios
            .post("/api/points-mall/system-configuration/set-init-data", data, {
              headers: { "X-Signature": signature },
              timeout: 100000,
            })
            .then((response) => {
              console.log(response.data.code);
              if (response.data.code == 0) {
                this.showNotification(
                  "正在构建商城，大概需要1-5分钟左右，期间暂时无法访问，请在1-5分钟后刷新页面",
                  "success"
                );
                setTimeout(() => {
                  window.location.reload();
                }, 10000);
              } else {
                this.showNotification(response.data.message, "warning");
              }
            })
            .catch(() => {
              this.buildLoading = false;
              this.showNotification("请求失败，请稍后重试", "error");
            });
        },

        // 生成签名
        generateSignature(data) {
          return CryptoJS.HmacSHA256(
            JSON.stringify(data),
            this.secretKey
          ).toString();
        },
      },
    });
    app.mount("#app");
  </script>
</html>

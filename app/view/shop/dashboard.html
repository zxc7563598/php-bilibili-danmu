<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积分商城控制台</title>
    <script src="/js/vue.3.5.12.js"></script>
    <script src="/js/axios.min.js"></script>
    <?php include 'layout/style.php'; ?>
    <script src="/js/apexcharts.js"></script>
    <style>
        /* 为图表添加自定义样式 */
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
    </style>
</head>

<body>
    <!-- 顶部 Navbar -->
    <?php $currentPage = 'dashboard'; ?>
    <?php include 'layout/navbar.php'; ?>
    <!-- 主要区域 -->
    <div class="columns menu-container" id="app">
        <!-- 左侧菜单栏 -->
        <?php include 'layout/menu.php'; ?>
        <!-- 主要内容区域 -->
        <div class="column" id="main-content">
            <div id="loading">
                加载中，请稍候...
            </div>
            <div id="main-content-body" style="padding: 1rem;">
                <!-- 仪表盘的统计信息 -->
                <div class="columns is-multiline">
                    <!-- CPU 占用卡片 -->
                    <div class="column is-one-quarter-desktop is-half-tablet is-full-mobile">
                        <div class="card">
                            <div class="card-content">
                                <p class="title">CPU</p>
                                <p class="subtitle is-6 mb-3">{{cpu.model}}</p>
                                <p class="subtitle is-7 mb-3">用户：{{cpu.user}}%</p>
                                <p class="subtitle is-7 mb-3">内核：{{cpu.sys}}%</p>
                                <p class="subtitle is-7 mb-3">空闲：{{cpu.idle}}%</p>
                                <progress class="progress" :class="progressColor((100-cpu.idle).toFixed(2))"
                                    :value="(100-cpu.idle).toFixed(2)"
                                    max="100">{{(100-cpu.idle).toFixed(2)}}%</progress>
                            </div>
                        </div>
                    </div>

                    <!-- 内存占用卡片 -->
                    <div class="column is-one-quarter-desktop is-half-tablet is-full-mobile">
                        <div class="card">
                            <div class="card-content">
                                <p class="title">内存</p>
                                <p class="subtitle is-6 mb-3">-</p>
                                <p class="subtitle is-7 mb-3">总计：{{memory.total}} Mb</p>
                                <p class="subtitle is-7 mb-3">已用：{{memory.used}} Mb</p>
                                <p class="subtitle is-7 mb-3">空闲：{{memory.free}} Mb</p>
                                <progress class="progress"
                                    :class="progressColor(((memory.used / memory.total)*100).toFixed(2))"
                                    :value="((memory.used / memory.total)*100).toFixed(2)" max="100">{{((memory.used /
                                    memory.total)*100).toFixed(2)}}%</progress>
                            </div>
                        </div>
                    </div>

                    <!-- 磁盘占用卡片 -->
                    <div class="column is-one-quarter-desktop is-half-tablet is-full-mobile"
                        v-for="(item,index) in disk" :key="index">
                        <div class="card">
                            <div class="card-content">
                                <p class="title">磁盘</p>
                                <p class="subtitle is-6 mb-3">{{item.device}}</p>
                                <p class="subtitle is-7 mb-3">大小：{{item.size}} Mb</p>
                                <p class="subtitle is-7 mb-3">已用：{{item.used}} Mb</p>
                                <p class="subtitle is-7 mb-3">空闲：{{item.free}} Mb</p>
                                <progress class="progress"
                                    :class="progressColor((((item.used / item.size)*100)*100).toFixed(2))"
                                    :value="(item.used / item.size)*100" max="100">{{(((item.used /
                                    item.size)*100)*100).toFixed(2)}}%</progress>
                            </div>
                        </div>
                    </div>

                    <!-- 今日新增 -->
                    <div class="column is-one-quarter-desktop is-half-tablet is-full-mobile">
                        <div class="card">
                            <div class="card-content">
                                <p class="title">新增</p>
                                <p class="subtitle">{{add}} 个大航海</p>
                                <progress class="progress is-link" value="100" max="100">75%</progress>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="columns is-multiline">
                    <!-- 折线图：CPU 占用 -->
                    <div class="column is-one-half-desktop is-full-tablet is-full-mobile">
                        <div class="card">
                            <div class="card-content">
                                <div class="chart-container">
                                    <div id="cpu-chart"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 折现图：内存占用 -->
                    <div class="column is-one-half-desktop is-full-tablet is-full-mobile">
                        <div class="card">
                            <div class="card-content">
                                <div class="chart-container">
                                    <div id="memory-chart"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 底部 Footer -->
    <?php include 'layout/footer.php'; ?>
</body>
<!-- JavaScript 用于图表展示 -->

<script>
    function convertToTime(minutesFromMidnight) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');  // 月份需要加1，且格式化为两位数
        const day = String(now.getDate()).padStart(2, '0');         // 格式化为两位数
        const hours = Math.floor(minutesFromMidnight / 60);
        const minutes = minutesFromMidnight % 60;
        const time = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        return `${year}-${month}-${day} ${time}`;
    }
    function memory(data) {
        var categories = [];
        for (let i = 0; i < 288; i++) {
            categories.push('');
        }
        new ApexCharts(document.querySelector("#memory-chart"), {
            chart: {
                type: 'line',
                height: 350,
                toolbar: {
                    show: false  // 禁用右上角的工具栏按钮
                },
                zoom: {
                    enabled: false, // 禁用鼠标滚轮缩放
                }
            },
            series: [{
                name: '内存 占用',
                data: data  // 模拟数据
            }],
            yaxis: {
                max: 100  // 设置 Y 轴最大值为 100
            },
            xaxis: {
                categories: categories,  // 时间点
                min: 0,
                max: 288,
                tickAmount: 288
            },
            tooltip: {
                enabled: true,  // 启用提示框
                shared: true,  // 如果为 true，会同时显示多个数据系列的内容
                followCursor: true,  // 提示框跟随鼠标移动
                intersect: false,  // 设置为 true 时，只有在鼠标与数据点重合时才显示提示框
                y: {
                    formatter: function (value) {
                        return value + '%';  // 自定义显示 Y 轴的数据格式
                    }
                },
                x: {
                    formatter: function (value) {
                        return convertToTime(value) + ':00';  // 自定义 X 轴显示内容
                    }
                }
            },
            stroke: {
                show: true,           // 显示折线
                curve: 'smooth',      // 平滑曲线
                width: 1              // 设置折线的宽度为 5
            },
            title: {
                text: '内存 占用历史',
                align: 'center'
            }
        }).render();
    }
    function cpu(data) {
        var categories = [];
        for (let i = 0; i < 288; i++) {
            categories.push('');
        }
        new ApexCharts(document.querySelector("#cpu-chart"), {
            chart: {
                type: 'line',
                height: 350,
                toolbar: {
                    show: false  // 禁用右上角的工具栏按钮
                },
                zoom: {
                    enabled: false, // 禁用鼠标滚轮缩放
                }
            },
            series: [{
                name: 'CPU 占用',
                data: data  // 模拟数据
            }],
            yaxis: {
                max: 100  // 设置 Y 轴最大值为 100
            },
            xaxis: {
                categories: categories,  // 时间点
                min: 0,
                max: 288,
                tickAmount: 288
            },
            tooltip: {
                enabled: true,  // 启用提示框
                shared: true,  // 如果为 true，会同时显示多个数据系列的内容
                followCursor: true,  // 提示框跟随鼠标移动
                intersect: false,  // 设置为 true 时，只有在鼠标与数据点重合时才显示提示框
                y: {
                    formatter: function (value) {
                        return value + '%';  // 自定义显示 Y 轴的数据格式
                    }
                },
                x: {
                    formatter: function (value) {
                        return convertToTime(value) + ':00';  // 自定义 X 轴显示内容
                    }
                }
            },
            stroke: {
                show: true,           // 显示折线
                curve: 'smooth',      // 平滑曲线
                width: 1              // 设置折线的宽度为 5
            },
            title: {
                text: 'CPU 占用历史',
                align: 'center'
            }
        }).render();
    }
</script>

<script>
    const app = Vue.createApp({
        data() {
            return {
                loading: true,
                cpu: {
                    model: null, // CPU 模型
                    cores: null, // 物理核心数
                    logical_cores: null, // 逻辑核心数
                    cores_per_socket: null, // 每个插槽的核心数
                    user: null, // 用户空间占用 CPU 时间的百分比
                    sys: null, // 内核空间占用 CPU 时间的百分比
                    idle: null, // 空闲时间的百分比
                    wait: null // 等待 I/O 操作的时间百分比
                },
                memory: {
                    total: null, // 总内存
                    used: null, // 已用内存
                    free: null, // 空闲内存
                    cached: null, // 缓存内存
                    buffers: null // 缓冲区内存
                },
                disk: [],
                add: 0,
                secretKey: '<?php echo $secretKey ?>'
            };
        },
        created() {
            this.$nextTick(() => {
                this.getData();
                this.getHistoriesData();
            });
            // 设置定时任务
            this.intervalId = setInterval(() => {
                this.getData()
            }, 2000);
        },
        methods: {
            // 决定进度条颜色
            progressColor(number) {
                if (number < 40) {
                    return 'is-primary';
                }
                if (number < 75) {
                    return 'is-warning';
                }
                if (number > 75) {
                    return 'is-danger';
                }
                return 'is-link';
            },
            // 获取页面数据
            getData() {
                let data = {}
                let signature = CryptoJS.HmacSHA256(JSON.stringify(data), this.secretKey).toString();
                axios.post('/api/points-mall/dashboard/get-real-time-data', data, {
                    headers: { 'X-Signature': signature }
                }).then(response => {
                    if (response.data.code == 0) {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('main-content-body').style.display = 'block';
                        this.cpu = response.data.data.cpu;
                        this.memory = response.data.data.memory;
                        this.disk = response.data.data.disk;
                        console.log(response.data.data);
                    }
                });
            },
            // 获取CPU/内存历史数据
            getHistoriesData() {
                let data = {}
                let signature = CryptoJS.HmacSHA256(JSON.stringify(data), this.secretKey).toString();
                axios.post('/api/points-mall/dashboard/get-real-time-histories-data', data, {
                    headers: { 'X-Signature': signature }
                }).then(response => {
                    if (response.data.code == 0) {
                        const cpu_data = [];
                        const memory_data = [];
                        response.data.data.cpu.forEach(item => {
                            cpu_data.push(item);
                        })
                        response.data.data.memory.forEach(item => {
                            memory_data.push(item);
                        })
                        memory(memory_data);
                        cpu(cpu_data)
                    }
                });
            }
        },
        beforeDestroy() {
            clearInterval(this.intervalId);
        }
    });
    app.mount('#app');
</script>

</html>